#!/usr/bin/perl
use strict;
use warnings;

my $pcDefault = "nopc";
my $debugPort = 8957;

my @opts = (
  "-Psdm,mock",
  "-DskipTests",
  "-Dcheckstyle.skip=true"
);

sub run(@);

my $usage = "Usage:
  $0 [--super] [--debug] [pc|nopc]
     pc/nopc enable/disable precompile {default is $pcDefault}
";

sub main(@){
  my $super = shift if @_ > 0 and $_[0] =~ /^(--super)$/;
  my $debug = shift if @_ > 0 and $_[0] =~ /^(--debug)$/;
  my $pc = $pcDefault;
  $pc = shift if @_ > 0 and $_[0] =~ /^(pc|nopc)$/;
  die $usage if @_ > 0;

  my $precompile = $pc eq "pc" ? "true" : "false";
  @opts = (@opts, "-Dgwt.codeServer.precompile=$precompile");

  @opts = (@opts, "-Dgwt.superDevMode=false") if not defined $super;
  @opts = (@opts, "-Dgwt.debugPort=$debugPort") if defined $debug;

  my $goal;
  if(defined $super){
    $goal = "gwt:run-codeserver";
  }elsif(defined $debug){
    $goal = "gwt:debug";
  }else{
    $goal = "gwt:run";
  }

  my @cmd = ("mvn", @opts, $goal);
  print "@cmd\n";

  open FH, "-|", @cmd;
  my $line;
  while($line = <FH>){
    if($line =~ /^\[INFO\]             \[ERROR\]/){
      print "\n\n";
    }
    print $line;
    if($line =~ /\d+\.\d+s total -- Compile completed|The code server is ready./){
      run "alarm", "-s", "success";
    }elsif($line =~ /Compiler returned false/){
      run "alarm", "-s", "failure";
    }
  }
  close FH;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
