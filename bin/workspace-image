#!/usr/bin/perl
use strict;
use warnings;

my $ext = '.xbm';
my $srcDir = `echo -n \$HOME/.dzen2/icons/workspace-images`;
my $destDir = `echo -n \$HOME/.xmonad/workspace-images`;

if($ARGV[0] eq 'init'){
  system "rm $destDir/*.log";
  system "rm $destDir/*$ext";
  shift;
  for my $wsId(@ARGV){
    system "ln", "-sf", "$srcDir/blank$ext", "$destDir/$wsId$ext";
  }
  exit 0;
}

my $workspaceId = shift;
my $wmClass = shift;
my $wmName = shift;


my $targetImg = "$destDir/$workspaceId$ext";
my $targetLog = "$destDir/$workspaceId.log";

my @names;
for my $file(`ls -1 $srcDir`){
  chomp $file;
  if($file =~ /^(.*)$ext$/){
    push @names, $1;
  }
}

#class first, then name

my $targetName;
if($wmClass eq '' and $wmName eq ''){
  $targetName = 'blank';
}elsif($wmName =~ / \| Review Board - Mozilla Firefox$/i){
}elsif($wmName =~ /^eScribe .*- Mozilla Firefox$/i){
  $targetName = 'escribe';
}elsif($wmName =~ / \| Review Board - Mozilla Firefox$/i){
  $targetName = 'reviewboard';
}elsif(lc $wmClass eq 'gnome-terminal' and $wmName =~ / - VIM$/i){
  $targetName = 'vim';
}else{
  for my $name(@names){
    if($wmClass =~ /$name/i){
      $targetName = $name;
      last;
    }
  }
  if(not defined $targetName){ 
    for my $name(@names){
      if($wmName =~ /$name/i){
        $targetName = $name;
        last;
      }
    }
  }
}

$targetName = 'unknown' if not defined $targetName;

open FH, ">> $targetLog";
print FH time . "%%%$wmClass%%%$wmName%%%$targetName\n";
close FH;

system "ln", "-sf", "$srcDir/$targetName$ext", "$targetImg";

