#!/usr/bin/perl
use strict;
use warnings;

my $wifiConf = "$ENV{HOME}/wifi.conf";
my @networks;
if(-e $wifiConf){
  use Safe;
  my $unsafeCode = `cat $wifiConf`;
  @networks = new Safe() -> reval($unsafeCode);
}

my $lastScanFile = "/tmp/wscan-last";

my $dev = `wlan`;
chomp $dev;

my $iwlist;
if(@ARGV == 0){
  $iwlist = `sudo iwlist $dev scan`;
  if($? != 0){
    exit 1;
  }
  if($iwlist =~ s/^$dev\s*Scan completed :\n//){
    open FH, "> $lastScanFile";
    print FH $iwlist;
    close FH;
  }
}elsif(@ARGV == 1 and $ARGV[0] eq '-l'){
  $iwlist = `cat $lastScanFile`;
}else{
  die "Usage: $0   or  $0 -l\n";
}


my @cells = split /          Cell \d+ - /, $iwlist;
shift @cells;

sub parseCell($){
  my $cell = shift;
  $cell =~ /\s*ESSID:"(.*)"/;
  my $essid = $1;
  $cell =~ /\s*Quality=(\d+)\/(\d+)/;
  my $quality = $2 == 0 ? '??????' : sprintf "%.2f%%", $1*100.0/$2;
  $quality = ' 'x(7 - length $quality) . $quality;
  my $type = '?';
  if($cell =~ /WPA2/){
    $type = 'WPA2';
  }elsif($cell =~ /WPA/){
    $type = 'WPA';
  }
  return [$essid,$quality,$type];
}

sub trimPad($$){
  my ($s, $l) = @_;
  if(length $s > $l){
    $s = substr($s, 0, $l-2) . "^^";
  }
  return $s . ' 'x($l - length $s);
}



for my $cell(map {parseCell $_} @cells){
  my $foundStr = '';
  for my $network(@networks){
    my $essid = $$network[0];
    if($$cell[0] eq $essid){
      $foundStr = "[$$network[3]]";
      last;
    }
  }
  print trimPad($$cell[0], 20) . " | " .
        trimPad($$cell[1], 7) . " | " .
        trimPad($$cell[2], 4) . " | " .
        trimPad($foundStr, 5) . "\n";
}

