#!/usr/bin/env python
import gtk
import sys
import os

def getActions():
  return filter(None, [ None
    , Action("Shutdown",  "s",  True,  ["gksudo poweroff"    , sys.exit])
    , Action("Reboot",    "r",  True,  ["gksudo reboot"      , sys.exit])
    , Action("Sleep",     "l",  True,  ["gksudo pm-suspend"  , sys.exit])
    , Action("Hibernate", "h",  True,  ["gksudo pm-hibernate", sys.exit])
    , Action("Cancel",    None, True,  [sys.exit])
    , Action("Gui",       "g",  False, [showGui])
  ])

def showGui():
  ActionGui(filter((lambda a: a.isGui), getActions())).mainWindow()

def usage():
  u = "Usage: " + sys.argv[0] + " ARG"
  maxActLen, maxKeyLen, maxCmdLen, maxFunLen = [0,0,0,0]
  for a in filter(lambda a: a.key, getActions()):
    (act, key, cmd) = a.getFormattedAtts()
    maxActLen = max(len(act), maxActLen)
    maxKeyLen = max(len(key), maxKeyLen)
    maxCmdLen = max(len(cmd), maxCmdLen)
  for a in filter(lambda a: a.key, getActions()):
    (act, key, cmd) = a.getFormattedAtts()
    u += (""
      + "\n  " + key.ljust(maxKeyLen)
      + " => " + act.ljust(maxActLen)
      + "    " + cmd.ljust(maxCmdLen)
    )
  return u

def main(args):
  if len(args) == 2:
    for a in filter(lambda a: a.key, getActions()):
      if args[1].lower() == a.key.lower():
        a.run()
        sys.exit(0)
  print >> sys.stderr, usage()
  sys.exit(1)

def isstr(s):
  return isinstance(s, basestring)
def shell(cmd):
  os.system(cmd)

class Action():
  def __init__(self, name, key, isGui, cmds):
    self.name = name
    self.key = key
    self.isGui = isGui
    self.cmdFuns = map(lambda c: (lambda: shell(c)) if isstr(c) else c, cmds)
    self.cmdNames = map(lambda c: c if isstr(c) else c.__name__, cmds)
    self.labelText = name
    if self.key != None:
      self.labelText += " (" + self.key + ")"
  def getFormattedAtts(self):
    return [ self.name and self.name or ""
           , self.key and self.key or ""
           , ', '.join(self.cmdNames)
           ]
  def run(self):
    for c in self.cmdFuns: c()

class ActionButton(gtk.Button):
  def __init__(self, action):
    gtk.Button.__init__(self, action.labelText)
    self.connect("clicked", lambda widget: action.run())
    
class ActionGui():
  def __init__(self, actions):
    self.actions = actions
    self.box = gtk.VBox()
    self.box.add(gtk.Label(""
      + "escape cancels\n"
      + "up/down/enter to select\n"
      + "or press shortcut key"
    ))
    for a in self.actions:
      self.box.add(ActionButton(a))
  def mainWindow(self):
    window = gtk.Window()
    window.set_default_size(300, 500)
    window.set_position(gtk.WIN_POS_CENTER)
    window.set_title("Off")
    window.add(self.getGtkWidget())

    window.add_events(gtk.gdk.KEY_PRESS_MASK)
    window.connect("key_press_event", self.keyPress)

    window.connect("destroy", gtk.main_quit) 
    window.show_all()
    gtk.main()
  def keyPress(self, widget, event):
    if event.keyval == gtk.keysyms.Escape:
      sys.exit()
    for a in filter(lambda a: a.key, self.actions):
      if a.key.lower() == chr(event.keyval).lower():
        a.run()
  def getGtkWidget(self):
    return self.box

if __name__ == "__main__":
  main(sys.argv)

