#!/usr/bin/perl
use strict;
use warnings;

my $dir = "$ENV{HOME}/openvpn";
my $cert = "client.pem";
my $conf = "client.conf";
my $status = "status";

sub run(@);

sub main(@){
  ensureRoot();

  die "Usage: $0 on|off|toggle" if @_ != 1 or $_[0] !~ /^(on|off|toggle)$/;

  if($_[0] eq 'on'){
    print "starting, maybe...\n";
    chdir $dir or die "Couldnt cd to $dir\n";

    selectCert();
    die "no cert selected\n" if not -e $cert;
    run "rm", "-f", "status";
    run "openvpn", "--config", $conf, "--status", $status, "1";
  }elsif($_[0] eq 'off'){
    print "stopping, maybe...\n";
    run "pkill", "-9", "openvpn";
  }elsif($_[0] eq 'toggle'){
    run "pidof openvpn >/dev/null 2>/dev/null";
    exec $0, $? ? 'on' : 'off';
  }
}

sub ensureRoot(){
  if(`whoami` ne "root\n"){
    print "rerunning as root\n";
    exec "sudo", $0, @ARGV;
  }
}

sub selectCert(){
  my $hostCert = "$cert." . `hostname`;
  chomp $hostCert;
  my $defaultCert = "client.pem.default";

  run "rm", "-f", "client.pem" if -l "client.pem";
  run "ln", "-s", $hostCert, $cert if not -e $cert and -e $hostCert;
  run "ln", "-s", $defaultCert, $cert if not -e $cert and -e $defaultCert;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
