#!/usr/bin/perl
use strict;
use warnings;

my $user = `echo -n \$USER`;

sub npLine($){
  return "$user\tALL=(ALL) NOPASSWD: $_[0]\n";
}

my @sudoersExecs = qw(
);

my @customExecNames = split /\n/, `ls -1 \$HOME/utils/sudoers`;
push @customExecNames, 'n900';
my @customExecPaths = map {"/usr/local/sbin/$_"} @customExecNames;
my @setuidExecs = qw(led resolvchooser build-acpi-call cpu-set);

system "sudo cp -ar \$HOME/utils/sudoers/* /usr/local/sbin";
system "sudo chown root.root /usr/local/sbin/*";
for my $exec(@setuidExecs){
  system "sudo chmod +s /usr/local/sbin/$exec";
}


my %sudoersd = (
  "$user-custom" => \@customExecPaths,
  "$user-net" => [qw(
    /sbin/ifconfig
    /sbin/iwconfig
    /sbin/iwlist
    /sbin/dhclient
    /sbin/wpa_supplicant
    /usr/local/bin/ifdev
    /usr/local/bin/n900-ip
    /usr/local/bin/n900-tether
    /usr/local/bin/resolvchooser
    /usr/local/bin/wauto
    /usr/local/bin/wconnect
    /usr/local/bin/wscan
    /usr/local/bin/wstatus
  )],
  "$user-fcron" => [qw(
    /usr/local/sbin/fcron
    /usr/local/bin/fcrondyn
    /usr/local/bin/fcrontab
  )],
  "$user-i7z" => [qw(
    /usr/sbin/i7z
  )],
);



system "sudo cp /etc/sudoers.d/README /tmp/sudoersd_readme";
system "sudo rm /etc/sudoers.d/*";
system "sudo mv /tmp/sudoersd_readme /etc/sudoers.d/README";

for my $file(keys %sudoersd){
  my $execs = $sudoersd{$file};
  $file = "/etc/sudoers.d/$file";
  my $out = join '', map {npLine $_} @$execs;
  print "Writing file $file:\n";
  system "sudo sh -c 'touch $file; chmod 0440 $file'";
  open FH, "| sudo tee $file";
  print FH $out;
  close FH;
}
system "sudo chmod 0440 /etc/sudoers.d/*";

my %currentSudoersLines = map {$_ => 1} `sudo cat /etc/sudoers`;
for my $exec(@sudoersExecs){
  my $npLine = npLine $exec;
  my %currentSudoersLines = map {$_ => 1} `sudo cat /etc/sudoers`;
  if(not defined $currentSudoersLines{$npLine}){
    print "\n\nreally dangerous: dont say yes, do it yourself\n";
    print "the following line to /etc/sudoers:\n";
    print $npLine;

    print "overwrite /etc/sudoers, despite your better judgment? (y/N) ";
    if(lc <STDIN> eq "y\n"){
      system "sudo sh -c \"" .
        "chmod +w /etc/sudoers && " .
        "echo -n \\\"$npLine\\\" >> /etc/sudoers && " .
        "chmod -w /etc/sudoers" .
         "\"";
    }
  }
}
