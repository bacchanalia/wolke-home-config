#!/usr/bin/perl
use strict;
use warnings;
use ScriptScript;
ScriptScript::setOpts {runCommand => 0};

sub addSrcs();

sub main(@) {
    getRoot @_;

    my $which = shift || "";

    addSrcs;

    run qw(apt-get update);

    my %packages = readConfDir "../apt-packages";
    for my $group (sort grep {/$which/} keys %packages) {
        print "### installing $group\n";
        my @pkgs = map {s/\s*//g; $_} @{$packages{$group}};
        run qw(apt-get -y install), @pkgs;
    }
}

sub addSrcsCnts(@) {
    (@_, grep {my $l = $_; not grep {/$l/} @_}
         map {my $l = $_; $l =~ s/^deb /deb-src /; $l}
         @_)
}

sub addSrcs() {
    my @srcsorig = readFile "/etc/apt/sources.list";
    my @srcs = addSrcsCnts @srcsorig;
    writeFile "/etc/apt/sources.list", join '', @srcs unless @srcs ~~ @srcsorig;
}

main @ARGV;

