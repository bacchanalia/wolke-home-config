#!/usr/bin/perl
use strict;
use warnings;

system "apt-get install tp-smapi-source";
system "module-assistant prepare tp-smapi";
system "module-assistant auto-install tp-smapi";
system "modprobe tp-smapi";

open FH, '< /etc/modules';
my @lines = <FH>;
my @newlines;
for my $line(@lines){
  push @newlines, $line if $line !~ /^(tp-smapi|hdaps)\n?$/;
}
push @newlines, "tp-smapi\n";
push @newlines, "hdaps\n";
close FH;

open FH, '> /etc/modules';
print FH @newlines;
close FH;

system "chmod o+w /etc/modules";
system
  "echo 'KERNEL==\"event[0-9]*\", " .
  "ATTRS{phys}==\"hdaps/input1\"," .
  "ATTRS{modalias}==\"input:b0019v1014p5054e4801-*\",".
  "SYMLINK+=\"input/hdaps/accelerometer-event\"'".
  " | sudo tee /etc/udev/rules.d/51-hdaps.rules";
system "update-initramfs -u";

system
  "echo 'options thinkpad_ec force_io=1' > " .
  "/etc/modprobe.d/tp_smapi.conf";
system "modprobe -a tp_smapi hdaps";

my $w520_patch = '
--- thinkpad_ec.c	2011-06-02 15:54:21.972196339 -0400
+++ thinkpad_ec.c.patched	2011-06-02 15:55:55.282196374 -0400
@@ -460,6 +460,12 @@
 		TP_DMI_MATCH("IBM", "ThinkPad A30"),
 		TP_DMI_MATCH("IBM", "ThinkPad T23"),
 		TP_DMI_MATCH("IBM", "ThinkPad X24"),
+		TP_DMI_MATCH("LENOVO", "ThinkPad"),
 		{ .ident = NULL }
 	};
 	return dmi_find_substring(DMI_DEV_TYPE_OEM_STRING,
';

open FH, "> /tmp/tp_smapi-w520.patch";
print FH $w520_patch;
close FH;

system "patch /usr/src/tp-smapi-0.40/thinkpad_ec.c /tmp/tp_smapi-w520.patch";
