#!/usr/bin/perl
use strict;
use warnings;

my $dir = "$ENV{HOME}/openvpn";
my $cert = "client.pem";
my $status = "status";
my $user = "ewolk";
my $defaultName = "escribe";

sub ensureRoot();
sub getPasswordFile();
sub selectCert();
sub run(@);

my $usage = "Usage:
  $0 on|off|toggle [CONF_NAME]
";

sub main(@){
  ensureRoot();
  my $cmd = shift;
  my $name = shift;

  die $usage if @_ != 0 or not defined $cmd or $cmd !~ /^(on|off|toggle)$/;
  chdir $dir or die "couldnt set cwd to $dir\n";

  $name = $defaultName if not defined $name;
  $name =~ s/\.conf$//;
  die "$dir/$name.conf not found\n" if not -f "$name.conf";

  if($cmd eq 'on'){
    print "starting, maybe...\n";


    selectCert();
    die "no cert selected\n" if not -e $cert;
    run "rm", "-f", "status";
    run "openvpn",
      "--auth-user-pass", getPasswordFile(),
      "--config", "$name.conf",
      "--status", $status,
      "--reneg-sec", 0,
      "1";
  }elsif($cmd eq 'off'){
    print "stopping, maybe...\n";
    run "pkill", "-9", "openvpn";
  }elsif($cmd eq 'toggle'){
    run "pidof openvpn >/dev/null 2>/dev/null";
    exec $0, ($? == 0 ? 'off' : 'on'), defined $name ? ($name) : ();
  }
}

sub ensureRoot(){
  if(`whoami` ne "root\n"){
    print "rerunning as root\n";
    exec "sudo", $0, @ARGV;
  }
}

sub getPasswordFile(){
  my $pass = `yubi`;
  chomp $pass;

  my $file = "/tmp/openvpn-auth-" . time;
  open FH, "> $file" or die "Cant write to $file\n";
  print FH "$user\n";
  print FH "$pass\n";
  close FH;
  return $file;
}

sub selectCert(){
  my $hostCert = "$cert." . `hostname`;
  chomp $hostCert;
  my $defaultCert = "client.pem.default";

  run "rm", "-f", "client.pem" if -l "client.pem";
  run "ln", "-s", $hostCert, $cert if not -e $cert and -e $hostCert;
  run "ln", "-s", $defaultCert, $cert if not -e $cert and -e $defaultCert;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
