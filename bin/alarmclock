#!/usr/bin/perl
use strict;
use warnings;

my $dir = `echo -n \$HOME/.alarms`;
if(not -d $dir){
  die "$dir is not a directory\n";
}
chdir $dir;
my @alarmFiles = `ls $dir`;


my @daysOfTheWeek = qw(su mo tu we th fr sa);
my $dayPattern = join '|', @daysOfTheWeek;
my $dayRe = qr/$dayPattern/;

sub getRepeatDays($){
  my $alarm = shift;
  if($alarm =~ /^\@\s/){
    return [];
  }elsif($alarm =~ /^[^@]/){
    return undef;
  }elsif($alarm =~ /^\@($dayRe)-($dayRe)\s/){
    my $startIndex;
    my $endIndex;
    for(my $i=0; $i<@daysOfTheWeek; $i++){
      $startIndex = $i if $daysOfTheWeek[$i] eq $1;
      $endIndex = $i if $daysOfTheWeek[$i] eq $2;
    }
    my @dotw = (@daysOfTheWeek, @daysOfTheWeek);
    $endIndex += 7 if $endIndex < $startIndex;
    my @days = @dotw[$startIndex..$endIndex];
    return \@days;
  }elsif($alarm =~ /^\@($dayRe(?:,$dayRe)*)\s/){
    my @days = split /,/, $1;
    return \@days;
  }else{
    die "Improperly formatted repeat-days-of-the-week: $alarm\n";
  }
}

sub twodigit($){
  return $_[0] < 10 ? "0$_[0]" : $_[0];
}

sub getRelativeTimeSeconds($){
  my $time = shift;
  if($time =~ /^\d+$/){
    $time .= 'm';
  }

  if($time =~ /^ (?:(\d+)h)?  (?:(\d+)m)?  (?:(\d+)s)? $/x){
    my $s = 0;
    $s += $1 * 60 * 60 if defined $1;
    $s += $2 * 60 if defined $2;
    $s += $3 if defined $3;
    return $s;
  }else{
    return undef;
  }
}

for my $alarmFile(@alarmFiles){
  chomp $alarmFile;
  my $alarm = `cat $alarmFile`;
  chomp $alarm;
  if($alarm =~ /^#/ or $alarm =~ /^\s*$/){
    next;
  }

  my $repeat = getRepeatDays($alarm);
  $alarm =~ /^ (?:\@\S)? \s* (\S*) \s* (.*) $/x;
  my $time = $1;
  my $cmd = $2;
  my $relTimeSeconds = getRelativeTimeSeconds($time);
  if(defined $relTimeSeconds and $relTimeSeconds > 60*60*24){
    die "relative times should be < 24 hours, since they are time-only\n";
  }
  if(not defined $repeat and defined $relTimeSeconds){
    my $sex = time() + $relTimeSeconds;
    my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime($sex);
    $sec = twodigit $sec;
    $min = twodigit $min;
    $hour = twodigit $hour;
    $time = "$hour:$min:$sec";

    $alarm = "$time $cmd";
    if(open FH, "> $alarmFile"){
      print FH "$alarm\n";
      close FH;
    }else{
      print STDERR "Could not write abs time to $alarmFile: $!\n";
      $time = '';
    }
  }

  $time =~ s/am$//i;
  if($time =~ /(\d+)(.*)pm$/i){
    my $h = 12 + $1;
    $time = "$h$2";
  }

  $time = "$time:00" if $time =~ /^\d+$/;
  $time = "$time:00" if $time =~ /^\d+:\d+$/;

  if($time =~ /(\d+):(\d+):(\d+)/){
    my ($h, $m, $s) = ($1, $2, $3);
    if($h>=24 or $m>=60 or $s>=60){
      print STDERR "$time is malformed\n";
      print "$alarmFile ERROR!\n";
      next;
    }else{
      print "$alarmFile $time\n";
    }
  }else{
    print "$alarmFile ERROR!\n"; 
  }
}

