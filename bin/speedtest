#!/usr/bin/perl
use strict;
use warnings;

my $attempts = 8;

sub main(@){
  die "Usage: $0 URL\n" if @_ != 1;
  my $url = shift;

  my @speedsKBps;
  while($attempts-- > 0){
    my $f = "/tmp/speedtest-" . time . ".log";
    fork or exec "tail", "-F", $f;
    system "wget $url -o $f -O /dev/null";
    my $c = `cat $f`;
    if($c =~ /\((\d+(?:\.\d+)?)\s*(K|M|G)B\/s\)/){
      my ($val, $unit) = ($1, $2);
      $val *= 10**3 if $unit eq "M";
      $val *= 10**6 if $unit eq "G";
      print "\n\n\nGot: $val KB/s\n";
      push @speedsKBps, $val;
    }else{
      die "Error reading bandwidth from wget\n";
    }
  }
  die "Got no results\n" if @speedsKBps == 0;

  print "results: @speedsKBps\n";
  my $size = @speedsKBps;
  my $sum = 0;
  $sum += $_ foreach @speedsKBps;
  my $avg = $sum/@speedsKBps;
  print "$avg KB/s {average over $size attempts}\n";
}

&main(@ARGV);
