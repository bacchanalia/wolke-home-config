#!/usr/bin/env python
import gtk
import sys
import os

def getActions():
  return filter(None, [ None
    , Action("Shutdown",  "s",  "gksudo poweroff"    , sys.exit, True)
    , Action("Reboot",    "r",  "gksudo reboot"      , sys.exit, True)
    , Action("Sleep",     "l",  "gksudo pm-suspend"  , sys.exit, True)
    , Action("Hibernate", "h",  "gksudo pm-hibernate", sys.exit, True)
    , Action("Cancel",    None, None                 , sys.exit, True)
    , Action("Gui",       "g",  None                 , showGui,  False)
  ])

def showGui():
  ActionGui(filter((lambda a: a.gui), getActions())).mainWindow()

def usage():
  u = "Usage: " + sys.argv[0] + " ARG"
  maxActLen, maxKeyLen, maxCmdLen, maxFunLen = [0,0,0,0]
  for a in filter(lambda a: a.key, getActions()):
    (act, key, cmd, fun) = a.getFormattedAtts()
    maxActLen = len(act) > maxActLen and len(act) or maxActLen
    maxKeyLen = len(key) > maxKeyLen and len(key) or maxKeyLen
    maxCmdLen = len(cmd) > maxCmdLen and len(cmd) or maxCmdLen
    maxFunLen = len(fun) > maxFunLen and len(fun) or maxFunLen
  for a in filter(lambda a: a.key, getActions()):
    (act, key, cmd, fun) = a.getFormattedAtts()
    u += (""
      + "\n  " + key.ljust(maxKeyLen)
      + " => " + act.ljust(maxActLen)
      + "    " + cmd.ljust(maxCmdLen)
      + "    " + fun.ljust(maxFunLen)
    )
  return u

def main(args):
  if len(args) == 2:
    for a in filter(lambda a: a.key, getActions()):
      if args[1].lower() == a.key.lower():
        a.run()
        sys.exit(0)
  print >> sys.stderr, usage()
  sys.exit(1)


class Action():
  def __init__(self, name, key=None, cmd=None, fun=None, gui=True):
    self.name = name
    self.key = key
    self.cmd = cmd
    self.fun = fun
    self.gui = gui
    self.labelText = name
    if self.key != None:
      self.labelText += " (" + self.key + ")"
  def getFormattedAtts(self):
    return [ self.name and self.name or ""
           , self.key and self.key or ""
           , self.cmd and "'" + self.cmd + "'" or ""
           , self.fun and self.fun.__name__ + "()" or ""
           ]
  def run(self):
    if self.cmd != None:
      print self.cmd
      os.system(self.cmd)
    if self.fun != None:
      print self.fun.__name__ + "()"
      self.fun()

class ActionButton(gtk.Button):
  def __init__(self, action):
    gtk.Button.__init__(self, action.labelText)
    self.connect("clicked", lambda widget: action.run())
    
class ActionGui():
  def __init__(self, actions):
    self.actions = actions
    self.box = gtk.VBox()
    self.box.add(gtk.Label(""
      + "escape cancels\n"
      + "up/down/enter to select\n"
      + "or press shortcut key"
    ))
    for a in self.actions:
      self.box.add(ActionButton(a))
  def mainWindow(self):
    window = gtk.Window()
    window.set_default_size(300, 500)
    window.set_position(gtk.WIN_POS_CENTER)
    window.set_title("Off")
    window.add(self.getGtkWidget())

    window.add_events(gtk.gdk.KEY_PRESS_MASK)
    window.connect("key_press_event", self.keyPress)

    window.connect("destroy", gtk.main_quit) 
    window.show_all()
    gtk.main()
  def keyPress(self, widget, event):
    if event.keyval == gtk.keysyms.Escape:
      sys.exit()
    for a in filter(lambda a: a.key, self.actions):
      if a.key.lower() == chr(event.keyval).lower():
        a.run()
  def getGtkWidget(self):
    return self.box

if __name__ == "__main__":
  main(sys.argv)

