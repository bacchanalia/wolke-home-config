#!/usr/bin/perl
use strict;
use warnings;

use Time::HiRes qw(sleep);

system "killall -9 fluidsynth vmpk";

if(`dpkg -s fluidsynth | grep Status` ne "Status: install ok installed\n"){
  system "sudo", "apt-get", "install", "fluidsynth";
}
if(`dpkg -s vmpk | grep Status` ne "Status: install ok installed\n"){
  system "sudo", "apt-get", "install", "vmpk";
}

my $sf="$ENV{HOME}/Desktop/Music/soundfonts/PC51d.sf2";
my $outputOpts = "-a pulseaudio -z 2048 -c2";

my $config = `echo -n \$HOME/` .
  '.config/vmpk.sourceforge.net/Virtual MIDI Piano Keyboard.conf';

if(not -e $config){
  print "\n\n\n\n!!!!!NO CONFIG FILE YET: please exit vmpk normally\n\n\n\n";
  system "vmpk";
}

my $seqId = 'vmpk';
my $outport = "FLUID Synth ($seqId):0";

open FH, "< $config";
my @lines = <FH>;
close FH;
for my $line(@lines){
  if($line =~ s/^OutPort=.*/OutPort=$outport/){
    last;
  }
}

open FH, "> $config";
print FH @lines;
close FH;


system "fluidsynth -s -i $sf -o midi.alsa_seq.id='$seqId' $outputOpts &";
system "sleep 0.3";
system "vmpk &";
