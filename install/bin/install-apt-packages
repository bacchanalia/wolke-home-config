#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

sub addSrcs($);
sub doInstalls($);

sub main(@) {
    getRoot @_;

    my $skipUpdate = 0;
    $skipUpdate = shift if @_ > 0 and $_[0] eq '-s';
    my $which = shift || "";

    editFile "/etc/apt/sources.list", \&addDebSrcs;
    run qw(apt-get update) unless $skipUpdate;
    doInstalls $which;
}

sub addDebSrcs($) {
    my @lines = split "\n", shift;
    join "\n", (@lines, grep {my $l = $_; not grep {/$l/} @lines}
                        map  {my $l = $_; $l =~ s/^deb /deb-src /; $l}
                        @lines), "", ""
}

sub doInstalls($) {
    my ($which) = @_;

    my %packages = readConfDir "../apt-packages";
    for my $group (sort grep {/$which/} keys %packages) {
        print "### installing $group\n";
        my @pkgs = map {s/\s*//g; $_} @{$packages{$group}};
        run qw(apt-get -y install), @pkgs;
    }
}

main @ARGV;

