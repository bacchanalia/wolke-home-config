#!/usr/bin/perl
use strict;
use warnings;

my $EXEC = 'thunderbird-bin';

my %ACCOUNTS = (
  'Gmail' => 'G',
  'LilleGroup' => 'L',
  'AOL - LiberiFataliVIII' => 'A');

my $tb = `pidof $EXEC`;
my $isRunning = $tb =~ /^[0-9]+\n?$/;

my $BOLDMS = 'font-family="monospace" weight="bold"';

if(not $isRunning){
  print "<span $BOLDMS fgcolor=\"red\">x</span>";
}

my $dir = '~/.thunderbird/*.default';
my @accounts = `cat $dir/unread-counts 2>/dev/null`;
my $used = 0;
if(@accounts > 0){
  for my $acc(@accounts){
    if($acc =~ /^([0-9]+):(.*)\n?$/){
      my $count = $1;
      my $name = $2;
      my $display = $ACCOUNTS{$name};
      if($count > 0 && defined $display){
        print ' ' if $used > 0;
        print "<span $BOLDMS bgcolor=\"black\" fgcolor=\"green\">$count$display</span>";
        $used++;
      }
    }
  }
}else{
  print "<span $BOLDMS bgcolor=\"black\" fgcolor=\"red\">err</span>\n";
}

if($used == 0){
  my $msg;
  if($isRunning){
    $msg = ' 0';
  }else{
    $msg = '0';
  }
  print "<span $BOLDMS bgcolor=\"black\" fgcolor=\"white\">$msg</span>\n";
}
