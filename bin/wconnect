#!/usr/bin/perl
use strict;
use warnings;

my $wpaConf = '/tmp/wpa_supplicant.conf';

my $ssid = shift;
my $key = shift;
my $dev = `wlan`;
chomp $dev;

sub systemp(@){
  print join(' ', @_) . "\n";
  system @_;
}

my $lcssid = lc $ssid;

my $psk = $key;
$psk =~ s/^s://;
my $conf = "network={
       ssid=\"$ssid\"
       psk=\"$psk\"
}\n";
open FH, "> $wpaConf";
print FH $conf;
close FH;


systemp "sudo wdisconnect";
systemp "sudo ifconfig $dev up";
systemp "sudo iwconfig $dev essid $ssid";# key $key";
systemp "sudo wpa_supplicant -Dwext -i$dev -c$wpaConf &";
sleep 1;
systemp "sudo resolvchooser google";
systemp "sudo dhclient -d $dev &";
