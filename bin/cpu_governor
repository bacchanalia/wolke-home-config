#!/usr/bin/perl
use strict;
use warnings;

my $cpu = shift;
my $gov = shift;

my $arg = shift;
$arg = '' if not defined $arg;

my $BASEDIR='/sys/devices/system/cpu';

sub govdev($){
  my $cpudir = shift;
  return "$BASEDIR/$cpudir/cpufreq/scaling_governor";
}

my @cpudirs;
if($cpu eq 'all'){
  for my $cpudir(`ls $BASEDIR`){
    chomp $cpudir;
    if($cpudir =~ /^cpu\d+$/){
      push @cpudirs, $cpudir;
    }
  }
  if($arg ne 'silent'){
    my $home = `echo -n \$HOME`;
    open FH, "> $home/.cpu_governor";
    print FH "$gov\n";
    close FH;
  }
}else{
  push @cpudirs, "cpu$cpu";
}

for my $cpudir(@cpudirs){
  system "echo $gov > " . govdev $cpudir;
}
